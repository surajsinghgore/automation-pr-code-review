name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install google-generativeai PyGithub

      - name: Save AI script
        run: |
          cat > ai_review.py << 'SCRIPT_END'
          import os
          import sys
          import json
          import re
          from github import Github, Auth
          import google.generativeai as genai

          print("üîç Starting AI Code Review...")

          # Configure APIs
          genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
          auth = Auth.Token(os.getenv("GITHUB_TOKEN"))
          g = Github(auth=auth)

          # Get PR details
          repo = g.get_repo(os.getenv("REPO_NAME"))
          pr = repo.get_pull(int(os.getenv("PR_NUMBER")))
          commit = list(pr.get_commits())[-1]

          # Collect file changes
          files_to_review = []
          total_additions = 0
          total_deletions = 0

          for f in pr.get_files():
              if f.patch:  # Only review files with changes
                  total_additions += f.additions
                  total_deletions += f.deletions
                  files_to_review.append({
                      'filename': f.filename,
                      'patch': f.patch,
                      'sha': f.sha,
                      'status': f.status
                  })

          if not files_to_review:
              print("No files to review")
              sys.exit(0)

          print(f"üìä Found {len(files_to_review)} files to review")

          # Prepare prompt for Gemini
          prompt = f"""You are an expert code reviewer. Analyze the following code changes and provide SPECIFIC inline suggestions.

          IMPORTANT: Return your response as a valid JSON array with this exact structure:
          [
            {{
              "filename": "path/to/file.ext",
              "line": <line_number>,
              "severity": "error|warning|info",
              "message": "Brief description of the issue",
              "suggestion": "The exact code to replace the problematic line (optional)"
            }}
          ]

          Rules:
          1. Use "error" for bugs and critical issues
          2. Use "warning" for potential problems, security issues, performance
          3. Use "info" for style improvements and best practices
          4. Line numbers must be from the NEW file (lines starting with + in the diff)
          5. Only suggest changes for added or modified lines
          6. If suggesting code, provide the EXACT replacement code
          7. Focus on actual problems, not minor style preferences
          8. Maximum 3-5 suggestions per file to avoid overwhelming

          Files to review:
          """

          for file_data in files_to_review:
              prompt += f"\n\n=== File: {file_data['filename']} ===\n"
              prompt += f"Status: {file_data['status']}\n"
              prompt += f"```diff\n{file_data['patch']}\n```"

          prompt += "\n\nProvide ONLY the JSON array, no other text or markdown."

          try:
              # Get AI suggestions
              model = genai.GenerativeModel("models/gemini-2.5-flash")
              response = model.generate_content(prompt)
              
              # Parse response
              response_text = response.text.strip()
              # Remove markdown code blocks if present
              response_text = re.sub(r'^```json\s*', '', response_text)
              response_text = re.sub(r'\s*```$', '', response_text)
              
              suggestions = json.loads(response_text)
              
              if not suggestions:
                  print("No suggestions from AI")
                  sys.exit(0)
              
              print(f"üí° Got {len(suggestions)} suggestions")
              
              # Create review comments
              review_comments = []
              
              for suggestion in suggestions:
                  filename = suggestion['filename']
                  line = suggestion['line']
                  message = suggestion['message']
                  severity = suggestion.get('severity', 'info')
                  code_suggestion = suggestion.get('suggestion', '')
                  
                  # Find the file in PR files
                  pr_file = None
                  for f in pr.get_files():
                      if f.filename == filename:
                          pr_file = f
                          break
                  
                  if not pr_file:
                      print(f"‚ö†Ô∏è File {filename} not found in PR")
                      continue
                  
                  # Map severity to emoji
                  emoji_map = {
                      'error': 'üî¥',
                      'warning': '‚ö†Ô∏è',
                      'info': 'üí°'
                  }
                  emoji = emoji_map.get(severity, 'üí°')
                  
                  # Format comment body
                  if code_suggestion:
                      # GitHub suggestion format
                      body = f"{emoji} **{message}**\n\n```suggestion\n{code_suggestion}\n```"
                  else:
                      body = f"{emoji} **{message}**"
                  
                  review_comments.append({
                      'path': filename,
                      'line': int(line),
                      'body': body
                  })
              
              if not review_comments:
                  print("No valid comments to post")
                  sys.exit(0)
              
              # Create a review with all comments
              print(f"üìù Creating review with {len(review_comments)} comments...")
              
              # Sort comments by file and line for better organization
              review_comments.sort(key=lambda x: (x['path'], x['line']))
              
              # Create the review
              review = pr.create_review(
                  commit=commit,
                  body="ü§ñ **AI Code Review by Gemini 2.5**\n\nI've analyzed your code and left inline suggestions. Click on the suggestions to apply them directly!",
                  event='COMMENT',
                  comments=review_comments
              )
              
              print("‚úÖ Review posted successfully!")
              
              # Post summary comment
              error_count = sum(1 for s in suggestions if s.get('severity') == 'error')
              warning_count = sum(1 for s in suggestions if s.get('severity') == 'warning')
              info_count = sum(1 for s in suggestions if s.get('severity') == 'info')
              
              summary = f"""### üìä AI Review Summary

          **Files reviewed:** {len(files_to_review)}
          **Lines changed:** +{total_additions} / -{total_deletions}

          **Issues found:**
          - üî¥ Errors: {error_count}
          - ‚ö†Ô∏è Warnings: {warning_count}
          - üí° Suggestions: {info_count}

          Check the inline comments above for detailed feedback and click "Apply suggestion" to accept the changes!
          """
              
              pr.create_issue_comment(summary)
              
          except json.JSONDecodeError as e:
              print(f"‚ùå Failed to parse AI response as JSON: {e}")
              print(f"Response was: {response_text[:500]}...")
              
              # Fallback to simple comment
              pr.create_issue_comment(f"""### ü§ñ AI Code Review

          Unable to generate inline suggestions. Here's the raw review:

          {response.text}

          **Files:** {len(files_to_review)} (+{total_additions}/-{total_deletions} lines)
          """)
              sys.exit(1)
              
          except Exception as e:
              print(f"‚ùå Error: {str(e)}")
              pr.create_issue_comment(f"""### ü§ñ AI Code Review

          Review failed: {str(e)[:200]}

          **Files:** {len(files_to_review)} (+{total_additions}/-{total_deletions} lines)
          """)
              sys.exit(1)
          SCRIPT_END

      - name: Run AI Review Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
        run: python ai_review.py