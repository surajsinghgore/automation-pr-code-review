name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          pip install google-generativeai PyGithub

      - name: Save AI script
        run: |
          cat > ai_review.py << 'SCRIPT_END'
          import os
          import sys
          from github import Github, Auth
          import google.generativeai as genai

          print("üîç Running AI Review...")

          # Configure Gemini API
          genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
          
          # Configure GitHub API with new Auth method
          auth = Auth.Token(os.getenv("GITHUB_TOKEN"))
          g = Github(auth=auth)

          # Get PR details
          repo = g.get_repo(os.getenv("REPO_NAME"))
          pr = repo.get_pull(int(os.getenv("PR_NUMBER")))

          # Collect changed code
          changed_code = ""
          file_count = 0
          total_additions = 0
          total_deletions = 0

          for f in pr.get_files():
              file_count += 1
              total_additions += f.additions
              total_deletions += f.deletions
              
              patch = f.patch or ""
              if patch:
                  changed_code += f"### File: {f.filename}\n```diff\n{patch}\n```\n\n"

          # Check if there are changes to review
          if not changed_code:
              print("No code changes to review")
              sys.exit(0)

          # Limit the diff size for free tier token limits
          if len(changed_code) > 20000:
              changed_code = changed_code[:20000] + "\n\n... (diff truncated due to size)"

          prompt = f"""You are an expert code reviewer. Review this PR diff and provide actionable feedback.

          Focus on:
          - üêõ **Bugs**: Logic errors, potential crashes, edge cases
          - üîí **Security**: Vulnerabilities, unsafe practices
          - ‚ö° **Performance**: Inefficiencies, optimization opportunities
          - üé® **Code Quality**: Naming, structure, best practices

          Be concise but specific. For each issue, mention:
          1. What the problem is
          2. Which file/line it affects
          3. How to fix it

          PR Statistics:
          - Files changed: {file_count}
          - Lines added: {total_additions}
          - Lines deleted: {total_deletions}

          PR Diff:
          {changed_code}
          """

          try:
              # Use the correct model for free tier - gemini-2.5-flash
              model = genai.GenerativeModel("models/gemini-2.5-flash")
              
              response = model.generate_content(prompt)
              
              # Format the comment
              comment = f"""### ü§ñ AI Code Review (Gemini 2.5 Flash)

          **PR Summary:** {file_count} file(s) changed (+{total_additions} / -{total_deletions} lines)

          ---

          {response.text}

          ---

          *This is an automated review. Please verify suggestions before implementing.*
          *React with üëç if helpful, üëé if not useful.*
          """
              
              pr.create_issue_comment(comment)
              print("‚úÖ AI Review posted successfully!")
              
          except Exception as e:
              print(f"‚ùå Error during review: {str(e)}")
              # Post a simple comment if AI review fails
              fallback_comment = f"""### ü§ñ AI Code Review

          Unable to generate detailed AI review.
          
          **PR Summary:** {file_count} file(s) changed (+{total_additions} / -{total_deletions} lines)

          Manual review checklist:
          - [ ] No critical bugs or logic errors
          - [ ] No security vulnerabilities  
          - [ ] Performance is acceptable
          - [ ] Code follows project standards
          - [ ] Tests are included/updated
          
          Error details: {str(e)[:200]}
          """
              pr.create_issue_comment(fallback_comment)
              sys.exit(1)
          SCRIPT_END

      - name: Run AI Review Script
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
        run: python ai_review.py