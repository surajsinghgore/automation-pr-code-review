name: Gemini Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get PR diff
        id: diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the diff for this PR
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt
          
          # Check if diff exists and has content
          if [ -s pr_diff.txt ]; then
            echo "Diff file created successfully"
            echo "diff_exists=true" >> $GITHUB_OUTPUT
          else
            echo "No diff found"
            echo "diff_exists=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Setup Node.js
        if: steps.diff.outputs.diff_exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Run Gemini Review
        if: steps.diff.outputs.diff_exists == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        run: |
          node << 'SCRIPT_END'
          const fs = require('fs');
          const https = require('https');
          
          const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
          const GITHUB_TOKEN = process.env.GITHUB_TOKEN;
          const PR_NUMBER = process.env.PR_NUMBER;
          const REPO = process.env.REPO;
          const PR_TITLE = process.env.PR_TITLE;
          const PR_AUTHOR = process.env.PR_AUTHOR;
          
          // Read the diff
          const diff = fs.readFileSync('pr_diff.txt', 'utf8');
          
          console.log('üìä Diff size:', diff.length, 'characters');
          console.log('üîç Analyzing code changes...\n');
          
          // Prepare prompt for Gemini
          const prompt = `You are an expert code reviewer. Analyze the following Pull Request and provide a detailed, constructive code review.

PR Title: ${PR_TITLE}
Author: @${PR_AUTHOR}

Code Changes:
${diff.substring(0, 30000)}

Please provide:
1. **Summary**: Brief overview of the changes
2. **Strengths**: What's good about this code
3. **Issues Found**: Any bugs, security concerns, or problems (be specific with line references if possible)
4. **Suggestions**: Improvements for code quality, performance, or best practices
5. **Questions**: Any clarifications needed

Format your response in clear markdown with emojis for better readability.`;

          // Call Gemini API
          function callGemini() {
            return new Promise((resolve, reject) => {
              const postData = JSON.stringify({
                contents: [{
                  parts: [{ text: prompt }]
                }],
                generationConfig: {
                  temperature: 0.7,
                  maxOutputTokens: 2048
                }
              });
              
              const options = {
                hostname: 'generativelanguage.googleapis.com',
                path: `/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`,
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                }
              };
              
              console.log('ü§ñ Calling Gemini API...');
              
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  console.log('‚úÖ Gemini API response received');
                  
                  try {
                    const response = JSON.parse(data);
                    
                    if (response.error) {
                      console.error('‚ùå Gemini API Error:', response.error);
                      reject(new Error(response.error.message));
                      return;
                    }
                    
                    const review = response.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (!review) {
                      console.error('‚ùå No review generated');
                      reject(new Error('No review text found'));
                      return;
                    }
                    
                    resolve(review);
                  } catch (e) {
                    console.error('‚ùå Parse error:', e.message);
                    reject(e);
                  }
                });
              });
              
              req.on('error', reject);
              req.write(postData);
              req.end();
            });
          }
          
          // Post comment to PR
          function postComment(reviewText) {
            return new Promise((resolve, reject) => {
              const comment = `## ü§ñ Gemini AI Code Review

${reviewText}

---
*üìù This review was automatically generated by Gemini AI*
*üîÑ React to this comment with üëç if helpful, or üëé if you disagree*`;
              
              const postData = JSON.stringify({ body: comment });
              
              const options = {
                hostname: 'api.github.com',
                path: `/repos/${REPO}/issues/${PR_NUMBER}/comments`,
                method: 'POST',
                headers: {
                  'User-Agent': 'Gemini-Code-Review-Bot',
                  'Authorization': `token ${GITHUB_TOKEN}`,
                  'Content-Type': 'application/json',
                  'Accept': 'application/vnd.github.v3+json'
                }
              };
              
              console.log('üí¨ Posting review comment to PR...');
              
              const req = https.request(options, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  if (res.statusCode === 201) {
                    console.log('‚úÖ Comment posted successfully!');
                    resolve(data);
                  } else {
                    console.error('‚ùå Failed to post comment:', res.statusCode);
                    reject(new Error(`Failed to post: ${res.statusCode}`));
                  }
                });
              });
              
              req.on('error', reject);
              req.write(postData);
              req.end();
            });
          }
          
          // Main execution
          async function main() {
            try {
              const review = await callGemini();
              console.log('üìÑ Review generated:', review.substring(0, 200) + '...\n');
              
              await postComment(review);
              console.log('üéâ Code review completed successfully!');
            } catch (error) {
              console.error('üí• Error:', error.message);
              
              // Try to post error comment
              try {
                await postComment(`‚ö†Ô∏è **Code Review Failed**\n\nError: ${error.message}\n\nPlease check the workflow logs for details.`);
              } catch (e) {
                console.error('Failed to post error comment:', e.message);
              }
              
              process.exit(1);
            }
          }
          
          main();
          SCRIPT_END
          
      - name: Summary
        if: always()
        run: |
          echo "‚úÖ Workflow completed"
          echo "üìä PR Number: ${{ github.event.pull_request.number }}"
          echo "üë§ Author: ${{ github.event.pull_request.user.login }}"