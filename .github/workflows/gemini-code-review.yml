name: Gemini Automated Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  gemini-code-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v3

      - name: Get PR diff
        id: pr_diff
        run: |
          echo "DIFF<<EOF" >> $GITHUB_ENV
          git fetch origin ${{ github.base_ref }}
          DIFF=$(git diff origin/${{ github.base_ref }}..${{ github.head_ref }})
          echo "$DIFF" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Review code with Gemini API
        id: gemini_review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          PYTHON=$(which python3)
          $PYTHON -m pip install requests
          cat <<EOF > gemini_review.py
import os
import requests

DIFF = os.environ.get('DIFF', '')
API_KEY = os.environ.get('GEMINI_API_KEY')
if not DIFF or not API_KEY:
    print("Missing diff or API key")
    exit(1)

prompt = f"Review this code diff for a pull request. Provide feedback for improvements, bugs, or potential issues.\\n\\n{DIFF}"

url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=" + API_KEY
payload = {
    "contents": [{"parts": [{"text": prompt}]}]
}

response = requests.post(url, json=payload)
if response.status_code == 200:
    result = response.json()
    review = result.get('candidates', [{}])[0].get('content', {}).get('parts', [{}])[0].get('text', '')
else:
    review = f"Failed to get review: {response.text}"

with open('review.txt', 'w') as f:
    f.write(review)
EOF
          $PYTHON gemini_review.py

      - name: Comment on PR with review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review.txt', 'utf8');
            if (review) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: review
              });
            }
